// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================
// ENUMS
// ===========================

enum ForgotPasswordStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum CMSUserRole {
  ADMIN
  STUDENT
  STAFF
}

enum DeviceType {
  ANDROID
  IOS
  WEB
  MAC
  WINDOWS
  LINUX
  DESKTOP
  OTHER
}

enum NotificationTargetType {
  USER
  MULTIPLE_USERS
  ROLE
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
  READ
}

enum AttendanceSessionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum ExamType {
  FINAL
  INTERNAL
  PRACTICAL
}

enum ExamStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

// ===========================
// USER
// ===========================

// AUTH DESIGN:
// - ADMIN: System credentials (password), seeded in DB
// - STAFF: Username + Password, created by Admin
// - STUDENT: Google Login via Firebase, self-registration with college email
//
// RULES:
// - firebaseUid → ONLY for STUDENT
// - password → ONLY for ADMIN / STAFF
// - Both are optional but never used together

model User {
  id   String @id @default(cuid())
  name String

  // Firebase UID - ONLY for students (Google Login)
  firebaseUid String? @unique

  username String? @unique
  email    String  @unique

  // Password - ONLY for admin & staff (hashed with bcrypt)
  password String?

  // User role determines auth method
  role CMSUserRole @default(STUDENT)

  isActive   Boolean @default(true)
  isVerified Boolean @default(false)

  phone           String?
  profileImageUrl String?

  verifyToken               String?
  verifyTokenExpiry         DateTime?
  forgotPasswordToken       String?
  forgotPasswordTokenExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String?
  updatedById String?

  // Department relation
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  // ---------------------------
  // RELATIONS
  // ---------------------------

  roles                 UserRole[]
  tokens                UserTokens[]
  notificationHistories NotificationHistory[]

  // Forgot password requests raised by user
  forgotPasswordRequests ForgotPasswordRequest[] @relation("UserForgotPasswordRequests")

  // Forgot password requests processed by admin
  processedPasswordRequests ForgotPasswordRequest[] @relation("ProcessedByAdmin")
  courses                   StudentCourse[]
  staffSubjects             StaffSubject[]
  timetables                TimeTable[]
  departmentHOD             DepartmentHOD?

  fcmDeliveryStatuses FcmDeliveryStatus[]
  profile             Profile?
  internalMarks       InternalMark[]
  externalMarks       ExternalMark[]

  attendanceSessions AttendanceSession[]
  attendanceRecords  AttendanceRecord[]
  notices            Notice[]

  // Assignment relations
  createdAssignments  Assignment[]           @relation("CreatedAssignments")
  studentSubmissions  AssignmentSubmission[] @relation("StudentSubmissions")
  markedSubmissions   AssignmentSubmission[] @relation("MarkedSubmissions")

  @@index([email])
  @@index([username])
  @@index([role])
  @@index([isActive])
  @@index([isVerified])
  @@index([departmentId])
}

model Profile {
  id        String    @id @default(cuid())
  userId    String    @unique
  bio       String?
  location  String?
  regno     String?   @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  gender    Gender?
  address   String?
  DOB       DateTime?
  semester  Int?
  section   String?
  cgpa      Float?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

// ===========================
// ROLE & RBAC
// ===========================

model Role {
  id          String      @id @default(cuid())
  name        CMSUserRole @unique
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  userRoles UserRole[]
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

// ===========================
// FORGOT PASSWORD REQUEST
// ===========================

model ForgotPasswordRequest {
  id     String               @id @default(cuid())
  userId String
  email  String
  status ForgotPasswordStatus @default(PENDING)

  requestedAt DateTime  @default(now())
  processedAt DateTime?
  processedBy String?
  reason      String?

  user  User  @relation("UserForgotPasswordRequests", fields: [userId], references: [id])
  admin User? @relation("ProcessedByAdmin", fields: [processedBy], references: [id])

  @@index([userId])
  @@index([status])
  @@index([processedBy])
}

// ===========================
// USER DEVICE TOKENS (FCM)
// ===========================

model UserTokens {
  id         Int         @id @default(autoincrement())
  userId     String?
  token      String
  deviceType DeviceType?
  deviceId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastUsed  DateTime @default(now())

  user       User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries FcmDeliveryStatus[]

  @@unique([userId, deviceId])
}

// ===========================
// NOTIFICATION HISTORY
// ===========================

model NotificationHistory {
  id    Int    @id @default(autoincrement())
  title String
  body  String
  data  Json?

  targetType NotificationTargetType
  targetIds  Json

  successCount Int @default(0)
  failureCount Int @default(0)

  status NotificationStatus @default(PENDING)
  sentAt DateTime           @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sentById String?
  sentBy   User?   @relation(fields: [sentById], references: [id], onDelete: SetNull)

  tokens FcmDeliveryStatus[]

  @@index([sentAt])
  @@index([targetType])
  @@index([sentById])
}

// ===========================
// FCM DELIVERY STATUS
// ===========================

model FcmDeliveryStatus {
  id             Int    @id @default(autoincrement())
  notificationId Int
  tokenId        Int
  userId         String

  status       NotificationStatus @default(PENDING)
  errorMessage String?
  errorCode    String?

  processedAt DateTime?
  deliveredAt DateTime?
  readAt      DateTime?

  createdAt DateTime @default(now())

  notification NotificationHistory @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  token        UserTokens          @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@index([tokenId])
  @@index([userId])
  @@index([status])
}

model Department {
  id        String           @id @default(cuid())
  name      String           @unique
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  status    DepartmentStatus @default(ACTIVE)

  users User[]

  courses    Course[]
  subjects   Subject[]
  timetables TimeTable[]
  hod        DepartmentHOD?

  attendanceSessions AttendanceSession[]
  assignments        Assignment[]
}

enum DepartmentStatus {
  ACTIVE
  INACTIVE
}

model Course {
  id             String     @id @default(cuid())
  title          String
  code           String     @unique
  description    String?
  type           CourseType @default(UNDERGRADUATE)
  duration       String // e.g., "4 Years", "2 Years"
  totalSemesters Int // Total number of semesters in the course
  credits        Int? // Total credit hours
  maxEnrollment  Int? // Maximum students allowed

  status CourseStatus @default(ACTIVE)

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  enrollments StudentCourse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([departmentId])
  @@index([status])
  @@index([type])
}

enum CourseType {
  UNDERGRADUATE
  POSTGRADUATE
  DIPLOMA
  PUC
  SCHOOL
}

model StudentCourse {
  id        String @id @default(cuid())
  studentId String
  courseId  String

  student User   @relation(fields: [studentId], references: [id])
  course  Course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

enum CourseStatus {
  ACTIVE
  INACTIVE
}

// ===========================
// ACADEMIC OPERATIONS
// ===========================

model Subject {
  id       String @id @default(cuid())
  name     String
  code     String @unique
  credits  Int?
  semester Int

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teachers   StaffSubject[]
  timetables TimeTable[]
  internalMarks InternalMark[]
  externalMarks ExternalMark[]

  attendanceSessions AttendanceSession[]
  assignments        Assignment[]

  @@index([departmentId])
  @@index([semester])
}

model StaffSubject {
  id        String @id @default(cuid())
  staffId   String
  subjectId String

  staff   User    @relation(fields: [staffId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])

  createdAt DateTime @default(now())

  @@unique([staffId, subjectId])
}

model TimeTable {
  id String @id @default(cuid())

  staffId      String
  subjectId    String
  departmentId String

  dayOfWeek DayOfWeek
  startTime DateTime
  endTime   DateTime
  room      String?
  semester  Int?
  section   String?

  staff      User       @relation(fields: [staffId], references: [id])
  subject    Subject    @relation(fields: [subjectId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendanceSessions AttendanceSession[]

  @@index([staffId])
  @@index([departmentId])
  @@index([dayOfWeek])
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

model DepartmentHOD {
  id           String @id @default(cuid())
  departmentId String @unique
  staffId      String @unique

  department Department @relation(fields: [departmentId], references: [id])
  staff      User       @relation(fields: [staffId], references: [id])

  assignedAt DateTime @default(now())
}

model AcademicYear {
  id        String             @id @default(cuid())
  name      String             @unique // e.g. "2024-2025"
  startDate DateTime
  endDate   DateTime
  status    AcademicYearStatus @default(UPCOMING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AcademicYearStatus {
  ACTIVE   @map("Active")
  UPCOMING @map("Upcoming")
  PAST     @map("Past")
}

model AcademicEvent {
  id          String            @id @default(cuid())
  title       String
  description String?
  date        DateTime
  type        AcademicEventType
  attachmentUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AcademicEventType {
  EVENT   @map("Event")
  HOLIDAY @map("Holiday")
  EXAM    @map("Exam")
}

model InternalMark {
  id             String         @id @default(cuid())
  studentId      String
  subjectId      String
  marks          Float
  maxMarks       Float          @default(20)
  semester       Int
  assessmentType AssessmentType @default(IA1)
  remarks        String?
  
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, subjectId, semester, assessmentType])
  @@index([studentId])
  @@index([subjectId])
}

model ExternalMark {
  id        String   @id @default(cuid())
  studentId String
  subjectId String
  marks     Float
  maxMarks  Float    @default(80) // Default external max
  semester  Int
  remarks   String?

  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, subjectId, semester])
  @@index([studentId])
  @@index([subjectId])
}

enum AssessmentType {
  IA1
  IA2
  IA3
  IA4
}

// ===========================
// ATTENDANCE
// ===========================

model AttendanceSession {
  id String @id @default(cuid())

  date        DateTime // Actual class date
  timetableId String

  staffId      String
  subjectId    String
  departmentId String

  semester Int
  section  String?

  startTime DateTime
  endTime   DateTime

  status   AttendanceSessionStatus @default(PENDING)
  isLocked Boolean                 @default(false)

  timetable  TimeTable  @relation(fields: [timetableId], references: [id])
  staff      User       @relation(fields: [staffId], references: [id])
  subject    Subject    @relation(fields: [subjectId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])

  records AttendanceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, timetableId])
  @@index([date])
  @@index([staffId])
  @@index([subjectId])
}

model AttendanceRecord {
  id String @id @default(cuid())

  sessionId String
  studentId String

  status  AttendanceStatus @default(PRESENT)
  remarks String?

  session AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  markedAt DateTime @default(now())

  @@unique([sessionId, studentId])
  @@index([studentId])
}

// ===========================
// NOTICE & ANNOUNCEMENTS
// ===========================

model Notice {
  id        String         @id @default(cuid())
  title     String
  content   String
  audience  NoticeAudience @default(ALL)
  pinned    Boolean        @default(false)
  
  authorId  String
  author    User           @relation(fields: [authorId], references: [id])

  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([audience])
  @@index([createdAt])
}

model Exam {
  id          String   @id @default(cuid())
  name        String
  code        String
  type        ExamType
  status      ExamStatus @default(SCHEDULED)
  date        DateTime
  startTime   DateTime
  endTime     DateTime
  room        String
  description String?
  
  // For result publication
  isResultPublished Boolean @default(false)
  resultsPublishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([status])
  @@index([type])
}

enum NoticeAudience {
  ALL
  STAFF
  STUDENTS
}

// ===========================
// ASSIGNMENTS
// ===========================

model Assignment {
  id          String   @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime
  semester    Int
  
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  
  subjectId    String?
  subject      Subject?   @relation(fields: [subjectId], references: [id])
  
  authorId     String
  author       User       @relation("CreatedAssignments", fields: [authorId], references: [id])

  submissions AssignmentSubmission[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([semester])
  @@index([departmentId])
  @@index([authorId])
}

model AssignmentSubmission {
  id           String   @id @default(cuid())
  assignmentId String
  studentId    String
  
  status       SubmissionStatus @default(PENDING)
  submittedAt  DateTime? // When it was marked as submitted
  
  markedById   String?
  markedBy     User?    @relation("MarkedSubmissions", fields: [markedById], references: [id])

  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student      User       @relation("StudentSubmissions", fields: [studentId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
}
